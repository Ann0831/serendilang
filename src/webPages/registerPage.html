<!DOCTYPE html>
<html lang="en" class="h-full overflow-hidden">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register</title>
    <link rel="icon" href="/favicon.png" type="image/png" />
    <!-- TailwindCSS -->
    <link href="/assets/css/tailwind.css" rel="stylesheet" />
    <!-- Tabler Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  </head>

  <body class="bg-gray-100 h-full flex flex-col text-gray-900 overflow-hidden">
    <!-- â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TOP-BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® -->
<header class="w-full h-16 bg-indigo-700 text-white flex items-center justify-between px-4 md:px-8 shadow-md sticky top-0 z-50">
        <a href="/" class="flex items-center space-x-2 hover:text-indigo-200 transition">
          <img src="/favicon.png" alt="Serendilang logo" class="w-8 h-8 rounded-md object-contain">
          <span class="text-xl font-semibold">Serendilang</span>
        </a>
      <div class="flex items-center space-x-6 relative">
        <!-- ä¸‹æ‹‰é¸å–®å®¹å™¨ -->
        <div class="relative">
          <!-- ä¸‹æ‹‰é¸å–®æŒ‰éˆ• -->
          <button id="topBar-doc-menuToggle" class="text-2xl focus:outline-none" aria-label="Toggle menu">
            â˜°
          </button>

          <!-- ä¸‹æ‹‰é¸å–® -->
          <div id="topBar-doc-menuLinks" class="hidden absolute right-0 top-14 w-48 bg-gray-50 text-gray-900 rounded-lg border border-gray-200 shadow-xl py-2 text-sm font-medium divide-y divide-gray-100
                   transform transition-all duration-300 ease-out origin-top-right opacity-0 scale-95">
            <a href="/about" class="block px-5 py-2.5 hover:bg-gray-100 hover:text-gray-900 transition">About</a>
            <a href="/terms" class="block px-5 py-2.5 hover:bg-gray-100 hover:text-gray-900 transition">Terms</a>
            <a href="/privacy" class="block px-5 py-2.5 hover:bg-gray-100 hover:text-gray-900 transition">Privacy</a>
            <a href="/contact" class="block px-5 py-2.5 hover:bg-gray-100 hover:text-gray-900 transition">Contact</a>
          </div>
        </div>

        <!-- Register / Login æ°¸é é¡¯ç¤º -->
        <div class="ml-3">
          <a href="/login" class="border border-white text-white rounded px-4 py-1 text-sm hover:bg-white hover:text-indigo-700 transition">
            Login
          </a>
        </div>
      </div>
    </header>
    <!-- â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ -->
<main class="flex flex-col flex-1 min-h-0">
  <div
    id="stepContainer"
    class="relative flex flex-col bg-white shadow-lg w-full flex-1 min-h-0 overflow-hidden pb-28 px-4 sm:px-6 md:px-8 pt-6 md:pt-8 rounded-none md:rounded-none"
  >
    <!-- âœ… ç¶ è‰²æ¨™é¡Œ -->
    <h1 class="text-2xl sm:text-3xl font-bold text-green-600 text-center mb-4">Register</h1>

    <!-- Step 1: Basic Info -->
    <form id="step1" class="flex flex-col justify-between flex-1 min-h-0 overflow-y-auto gap-4">
      <h2 class="text-xl sm:text-2xl font-semibold text-center text-indigo-700 mb-2">Step 1 / 3</h2>
      <p class="text-center text-gray-500 mb-2 text-sm sm:text-base">Create your basic account</p>

      <div class="flex flex-col items-center">
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
        <input
          type="text"
          id="username"
          required
          placeholder="Enter username"
          class="w-full max-w-sm md:max-w-md border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <div class="flex flex-col items-center">
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
        <input
          type="password"
          id="password"
          required
          placeholder="Set password"
          class="w-full max-w-sm md:max-w-md border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <div class="flex flex-col items-center">
        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
        <input
          type="password"
          id="confirmPassword"
          required
          placeholder="Re-enter password"
          class="w-full max-w-sm md:max-w-md border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
      </div>

      <div class="flex flex-col items-center">
        <label for="nativeLanguage" class="block text-sm font-medium text-gray-700 mb-1">Native Language</label>
        <select
          id="nativeLanguage"
          required
          class="w-full max-w-sm md:max-w-md border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <option value="">Select language</option>
        </select>
      </div>

      <div class="flex flex-col items-center">
        <label for="targetLanguage" class="block text-sm font-medium text-gray-700 mb-1">Target Language</label>
        <select
          id="targetLanguage"
          required
          class="w-full max-w-sm md:max-w-md border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <option value="">Select language</option>
        </select>
      </div>
    </form>

    <!-- Step 2: Upload Profile Picture -->
    <form id="step2" class="flex flex-col justify-between flex-1 min-h-0 overflow-y-auto gap-4 hidden">
      <h2 class="text-xl sm:text-2xl font-semibold text-center text-indigo-700 mb-2">Step 2 / 3</h2>
      <p class="text-center text-gray-500 mb-2 text-sm sm:text-base">Upload your profile picture (optional)</p>

      <div class="flex flex-col items-center justify-center gap-4">
        <img
          id="preview"
          src="https://placehold.co/120x120?text=No+Photo"
          alt="preview"
          class="w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border"
        />
        <input
          type="file"
          id="profilePic"
          accept="image/*"
          class="text-sm text-gray-600 w-full max-w-sm md:max-w-md"
        />
      </div>

      <button
        id="skipToStep3"
        type="button"
        class="text-sm text-gray-500 underline mt-2 hover:text-gray-700 self-center"
      >
        Skip this step
      </button>
    </form>

    <!-- Step 3: Invitation Code -->
      <form id="step3" class="flex flex-col justify-between flex-1 min-h-0 overflow-y-auto gap-4 hidden">
        <h2 class="text-xl sm:text-2xl font-semibold text-center text-indigo-700 mb-2">Step 3 / 3</h2>
        <p class="text-center text-gray-500 mb-2 text-sm sm:text-base">Enter your invitation code</p>

        <div class="flex flex-col items-center">
          <input
            type="text"
            id="invitationCode"
            placeholder="Invitation code (optional)"
            class="w-full max-w-sm md:max-w-md border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>

        <!-- âœ… åŒæ„æ¢æ¬¾ -->
        <div class="flex items-start justify-center space-x-2 mt-2">
          <input
            id="agree"
            type="checkbox"
            class="mt-1 h-4 w-4 text-indigo-600 border-gray-300 rounded"
            required
          />
          <label for="agree" class="text-sm text-gray-700 max-w-sm">
            I have read and agree to the
            <a href="/terms" target="_blank" rel="noopener noreferrer" class="text-indigo-600 underline hover:text-indigo-800">Terms of Service</a>
            and
            <a href="/privacy" target="_blank" rel="noopener noreferrer" class="text-indigo-600 underline hover:text-indigo-800">Privacy Policy</a>.
          </label>
        </div>

        <button
          id="finishBtn"
          type="submit"
          class="w-full max-w-sm md:max-w-md bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition font-medium self-center"
        >
          Finish
        </button>
      </form>
  </div>

  <!-- âœ… Bottom Navigation Bar: Fixed on mobile, inline on desktop -->
  <div
    id="regNav"
    class="fixed bottom-0 left-0 right-0 z-50 bg-white border-t border-gray-200
           px-4 py-3 pb-[calc(env(safe-area-inset-bottom)+0.75rem)]
           md:border-t-0 md:bg-transparent md:py-5"
  >
    <div class="max-w-screen-sm mx-auto flex items-center justify-center gap-6">
      <!-- â† Back -->
      <button
        id="prevStep"
        type="button"
        class="text-gray-600 hover:text-indigo-600 font-medium"
      >
        â† Back
      </button>

      <!-- Progress Dots -->
      <div class="flex justify-center gap-2">
        <div id="dot1" class="w-3 h-3 rounded-full bg-indigo-600"></div>
        <div id="dot2" class="w-3 h-3 rounded-full bg-gray-300"></div>
        <div id="dot3" class="w-3 h-3 rounded-full bg-gray-300"></div>
      </div>

      <!-- Next â†’ -->
      <button
        id="nextStep"
        type="button"
        class="text-indigo-600 hover:text-indigo-800 font-medium"
      >
        Next â†’
      </button>
    </div>
  </div>
</main>

<script type="module" src="/webPageInit/clear_userPublicDataCache.js"></script>
<script type="module">
  import { validlanguage } from "/utils/language/validLanguage.js";
  import { verifyUsernameBeforeRegister, registerService } from "/service/registerService.js";
  import { hashPassword } from "/utils/hashPassword.js"; 
  const { languages } = validlanguage();

  const nativeSelect = document.getElementById("nativeLanguage");
  const targetSelect = document.getElementById("targetLanguage");
  for (const lang of languages) {
    const opt1 = document.createElement("option");
    opt1.value = lang.lowercase;
    opt1.textContent = lang.name;
    nativeSelect.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = lang.lowercase;
    opt2.textContent = lang.name;
    targetSelect.appendChild(opt2);
  }

  const stepForms = [
    document.getElementById("step1"),
    document.getElementById("step2"),
    document.getElementById("step3"),
  ];
  const dots = [
    document.getElementById("dot1"),
    document.getElementById("dot2"),
    document.getElementById("dot3"),
  ];

  const prevBtn = document.getElementById("prevStep");
  const nextBtn = document.getElementById("nextStep");
  const skipBtn = document.getElementById("skipToStep3");
  const finishBtn = document.getElementById("finishBtn");

  const fileInput = document.getElementById("profilePic");
  const previewImg = document.getElementById("preview");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const confirmInput  = document.getElementById("confirmPassword");
  const invitationInput = document.getElementById("invitationCode");

  let current = 0; // 0,1,2 å°æ‡‰ step1~3
  let isChecking = false; // â˜… æª¢æŸ¥é–ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
  let isRegistering = false; // â˜… è¨»å†Šé–

  function updateNavUI() {
    prevBtn.disabled = current === 0;
    prevBtn.classList.toggle("opacity-40", prevBtn.disabled);
    const isLast = current === 2;
    nextBtn.classList.toggle("hidden", isLast);
    nextBtn.disabled = isLast || isChecking; // â˜… åªåœ¨æª¢æŸ¥ä¸­æˆ–æœ€å¾Œä¸€æ­¥æ‰é–ä½
    nextBtn.classList.toggle("opacity-40", nextBtn.disabled);
    if (skipBtn) {
      const showSkip = current === 1;
      skipBtn.classList.toggle("hidden", !showSkip);
    }
  }

  function showStep(index) {
    current = Math.max(0, Math.min(2, index));
    stepForms.forEach((form, i) => {
      form.classList.toggle("hidden", i !== current);
    });
    dots.forEach((dot, i) => {
      dot.className =
        "w-3 h-3 rounded-full " + (i === current ? "bg-indigo-600" : "bg-gray-300");
      dot.setAttribute("aria-current", i === current ? "step" : "false");
    });
    updateNavUI();
  }

  showStep(0);

  function validatePasswords(setMessage = true) {
    passwordInput.setCustomValidity("");
    confirmInput.setCustomValidity("");
    if (passwordInput.value.length < 8) {
      if (setMessage) passwordInput.setCustomValidity("Password must be at least 8 characters.");
    }
    if (confirmInput.value && confirmInput.value !== passwordInput.value) {
      if (setMessage) confirmInput.setCustomValidity("Passwords do not match.");
    }
    return passwordInput.checkValidity() && confirmInput.checkValidity();
  }

  prevBtn.addEventListener("click", () => showStep(current - 1));

  // â”€â”€â”€ Step1 â†’ Nextï¼šçµ±ä¸€æª¢æŸ¥é‚è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  nextBtn.addEventListener("click", async () => {
    if (isChecking) return; // â˜… é˜²æ­¢é‡è¤‡é»æ“Š
    if (current === 0) {
      const passOK = validatePasswords(true);
      if (!passOK) {
        stepForms[0].reportValidity();
        return;
      }

      const username = usernameInput.value.trim();
      if (!username) {
        usernameInput.setCustomValidity("Username cannot be empty.");
        usernameInput.reportValidity();
        return;
      }
      usernameInput.setCustomValidity("");

      // é¡¯ç¤º loading ç‹€æ…‹
      isChecking = true;
      nextBtn.disabled = true;
      const originalHTML = nextBtn.innerHTML;
      nextBtn.innerHTML = `<span class="animate-spin mr-2 border-2 border-t-transparent border-indigo-600 rounded-full w-4 h-4 inline-block align-middle"></span>Checking...`;

      try {
        const result = await verifyUsernameBeforeRegister(username);
        console.log("verifyUsernameBeforeRegister:", result);

        if (result.result === "available") {
          showStep(current + 1);
        } else if (result.result === "used") {
          usernameInput.setCustomValidity("This username is already taken.");
          usernameInput.reportValidity();
        } else if (result.result === "illegal") {
          usernameInput.setCustomValidity("Username can only contain letters, numbers, and underscores, and must be under 20 characters.");
          usernameInput.reportValidity();
        } else if (result.result === "error") {
          showNetworkErrorBanner();
        }
      } catch (err) {
        console.error("Error verifying username:", err);
        showNetworkErrorBanner();
      } finally {
        // é‚„åŸæŒ‰éˆ•
        isChecking = false;
        nextBtn.disabled = false;
        nextBtn.innerHTML = originalHTML;
        updateNavUI();
      }
      return;
    }

    showStep(current + 1);
  });

  if (skipBtn) {
    skipBtn.addEventListener("click", () => showStep(2));
  }

  document.addEventListener("keydown", (e) => {
    const active = document.activeElement;
    const inTyping =
      active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA" || active.tagName === "SELECT");
    if (inTyping) return;
    if (e.key === "ArrowLeft") showStep(current - 1);
    if (e.key === "ArrowRight") {
      if (current === 0) nextBtn.click();
      else showStep(current + 1);
    }
  });

  if (fileInput && previewImg) {
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      previewImg.src = URL.createObjectURL(file);
    });
  }

  stepForms.forEach((form) => {
    form.addEventListener("submit", (ev) => ev.preventDefault());
  });

  if (finishBtn) {
    finishBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (isRegistering) return;

      // æœ€çµ‚å†ä¿éšªæª¢æŸ¥ä¸€æ¬¡ Step1ï¼ˆé¿å…ä½¿ç”¨è€…è·³ä¾†è·³å»å°è‡´ç‹€æ…‹ç•°å¸¸ï¼‰
      const passOK = validatePasswords(true);
      const formOK = stepForms[0].checkValidity();
      if (!passOK || !formOK) {
        showStep(0);
        stepForms[0].reportValidity();
        return;
      }

      // âœ… æª¢æŸ¥æ˜¯å¦å‹¾é¸åŒæ„æ¢æ¬¾
      const agreeCheckbox = document.getElementById("agree");
      if (!agreeCheckbox || !agreeCheckbox.checked) {
        showToast("error", "Please agree to the Terms and Privacy Policy before continuing.");
        agreeCheckbox?.focus();
        return;
      }

      // æ”¶é›†è¨»å†Šè³‡æ–™
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      const native_language = nativeSelect.value || "";
      const target_language = targetSelect.value || "";
      const invitation_code = (invitationInput?.value || "").trim();

      // å‰ç«¯ç”¢ç”Ÿ SHA-256 é›œæ¹Šï¼ˆhexï¼‰
      const password_hash = await hashPassword(password);

      // âœ… çµ„æˆ payloadï¼ŒåŠ å…¥æ¢æ¬¾åŒæ„è³‡è¨Š
      const payload = {
        username,
        hashed_password: password_hash,
        nativelanguage: native_language,
        targetlanguage: target_language,
        profilePicFile: fileInput.files?.[0] || null,
        inviteCode: invitation_code,
        agree_terms: agreeCheckbox.checked,
        agree_privacy: agreeCheckbox.checked,
      };

      console.log("payload: ", payload);

      // é–ä½æŒ‰éˆ• + spinner
      isRegistering = true;
      const originalHTML = finishBtn.innerHTML;
      finishBtn.disabled = true;
      finishBtn.innerHTML = `<span class="animate-spin mr-2 border-2 border-t-transparent border-white rounded-full w-4 h-4 inline-block align-middle"></span>Submitting...`;

      try {
        const resp = await registerService(payload);
        // å…¼å®¹ registerService å›å‚³å­—ä¸²æˆ–ç‰©ä»¶
        const result = typeof resp === "string" ? resp : resp?.result;
        const reason = typeof resp === "object" ? (resp?.reason || resp?.message || resp?.res?.message) : undefined;

        if (result === "success") {
          showToast("success", "ğŸ‰ Registration successful! Redirecting...");
          setTimeout(() => {
            window.location.href = "/";
          }, 1500);
        } else {
          const msg = reason ? `Registration failed: ${reason}` : "Registration failed.";
          showToast("error", msg);
        }
      } catch (err) {
        console.error("registerService error:", err);
        showToast("error", "Network error during registration.");
      } finally {
        isRegistering = false;
        finishBtn.disabled = false;
        finishBtn.innerHTML = originalHTML;
      }
    });


  }

  // â”€â”€â”€ é¡¯ç¤ºç¶²è·¯éŒ¯èª¤æç¤ºï¼ˆå¹¾ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showNetworkErrorBanner() {
    showToast("error", "Network error, please try again later.");
  }

  // â”€â”€â”€ é€šç”¨ Toastï¼ˆ3 ç§’è‡ªå‹•æ¶ˆå¤±ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(type, message, duration = 3000) {
    const colors = {
      success: "bg-green-600",
      error: "bg-red-600",
      info: "bg-indigo-600",
    };
    const banner = document.createElement("div");
    banner.className =
      `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type] || colors.info} ` +
      "text-white px-4 py-2 rounded shadow-lg z-50";
    banner.textContent = message;
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), duration);
  }

</script>
    <script>
      const menuToggle = document.getElementById("topBar-doc-menuToggle");
      const menuLinks = document.getElementById("topBar-doc-menuLinks");

      menuToggle.addEventListener("click", (event) => {
        event.stopPropagation();
        const isHidden = menuLinks.classList.contains("hidden");

        if (isHidden) {
          menuLinks.classList.remove("hidden");
          // æ·¡å…¥
          requestAnimationFrame(() => {
            menuLinks.classList.remove("opacity-0", "scale-95");
            menuLinks.classList.add("opacity-100", "scale-100");
          });
        } else {
          // æ·¡å‡º
          menuLinks.classList.remove("opacity-100", "scale-100");
          menuLinks.classList.add("opacity-0", "scale-95");
          setTimeout(() => menuLinks.classList.add("hidden"), 200);
        }
      });

      document.addEventListener("click", (event) => {
        const isClickInside =
          menuLinks.contains(event.target) || menuToggle.contains(event.target);
        if (!isClickInside && !menuLinks.classList.contains("hidden")) {
          menuLinks.classList.remove("opacity-100", "scale-100");
          menuLinks.classList.add("opacity-0", "scale-95");
          setTimeout(() => menuLinks.classList.add("hidden"), 200);
        }
      });
    </script>
  </body>
</html>

